<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LineSpeak - English Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            accent: '#722ED1',
            success: '#52C41A',
            danger: '#F5222D',
            neutral: {
              100: '#F5F7FA',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .sentence-hover {
        @apply hover:bg-primary/5 dark:hover:bg-primary/10 transition-colors duration-200;
      }
      .sentence-active {
        @apply bg-primary/10 dark:bg-primary/20;
      }
      .sentence-mastered {
        @apply bg-success/5 dark:bg-success/10;
      }
      .progress-bar {
        @apply h-1 bg-neutral-200 dark:bg-neutral-500 rounded-full overflow-hidden;
      }
      .progress-fill {
        @apply h-full bg-primary transition-all duration-300 w-0;
      }
      .mastery-badge {
        @apply px-2.5 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary dark:bg-primary/20;
      }
      .number-badge {
        @apply w-6 h-6 rounded-full bg-primary/10 text-primary flex items-center justify-center text-sm font-medium mr-3 flex-shrink-0;
      }
      .masked-text {
        letter-spacing: 1px;
        white-space: pre-wrap; /* 确保掩膜文本能像原文本一样换行 */
        word-wrap: break-word; /* 长单词也能换行 */
      }
    }
  </style>
</head>
<body class="font-inter bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-100 transition-colors duration-300 min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white dark:bg-neutral-600 shadow-sm sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-comments text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-primary">LineSpeak</h1>
      </div>
      
      <div class="flex items-center space-x-4">
        <div id="mastery-percentage" class="mastery-badge hidden">
          0% Mastered
        </div>
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-neutral-200 dark:hover:bg-neutral-500 transition-colors">
          <i class="fa fa-moon-o dark:hidden text-neutral-500"></i>
          <i class="fa fa-sun-o hidden dark:inline text-yellow-300"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- 介绍部分 -->
    <section class="mb-8 text-center">
      <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-4 text-shadow">English Speaking Practice</h2>
      <p class="text-neutral-500 dark:text-neutral-300 max-w-2xl mx-auto">
        Enter your sentences, each on a new line. Click play buttons to practice, mark as mastered when you've learned it.
        Use the eye button to show/hide sentences for memorization practice.
      </p>
    </section>
    
    <!-- 输入区域 -->
    <section class="mb-8 bg-white dark:bg-neutral-600 rounded-xl shadow-md p-6 transition-all duration-300 transform hover:shadow-lg">
      <label for="text-input" class="block text-lg font-medium mb-3 text-neutral-600 dark:text-neutral-200">Enter your sentences (one per line):</label>
      <textarea 
        id="text-input" 
        class="w-full h-40 p-4 border border-neutral-200 dark:border-neutral-500 rounded-lg bg-neutral-50 dark:bg-neutral-700 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all resize-none"
        placeholder="Type or paste your English sentences, each on a new line...&#10;&#10;Hello, how are you today?&#10;I am learning English pronunciation.&#10;Could you please repeat that?&#10;Practice makes perfect."
      ></textarea>
      
      <div class="mt-4 flex justify-end">
        <button 
          id="process-btn" 
          class="bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-lg shadow transition-all flex items-center space-x-2 transform hover:scale-[1.02] active:scale-[0.98] mr-3"
        >
          <i class="fa fa-magic"></i>
          <span>Process Sentences</span>
        </button>
      </div>
    </section>
    
    <!-- 结果区域 -->
    <section id="results-section" class="mb-8 hidden">
      <div class="bg-white dark:bg-neutral-600 rounded-xl shadow-md p-6 transition-all duration-300">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold flex items-center">
            <i class="fa fa-list-alt text-primary mr-2"></i>
            Your Sentences
          </h3>
          
          <div class="flex space-x-2">
            <button 
              id="play-all-btn" 
              class="bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg shadow transition-all flex items-center space-x-2 text-sm"
            >
              <i class="fa fa-play"></i>
              <span>Play All</span>
            </button>
            <button 
              id="play-unmastered-btn" 
              class="bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg shadow transition-all flex items-center space-x-2 text-sm"
            >
              <i class="fa fa-forward"></i>
              <span>Play Unmastered</span>
            </button>
            <button 
              id="stop-all-btn" 
              class="bg-neutral-400 hover:bg-neutral-500 text-white px-4 py-2 rounded-lg shadow transition-all flex items-center space-x-2 text-sm hidden"
            >
              <i class="fa fa-stop"></i>
              <span>Stop</span>
            </button>
          </div>
        </div>
        
        <!-- 播放进度条 -->
        <div class="progress-bar mb-4">
          <div id="play-progress" class="progress-fill"></div>
        </div>
        
        <div id="sentences-container" class="space-y-6">
          <!-- 句子将在这里动态生成 -->
        </div>
      </div>
    </section>
    
    <!-- 提示卡片 -->
    <section class="bg-primary/5 dark:bg-primary/10 rounded-xl p-5 border border-primary/20 mb-8">
      <div class="flex items-start">
        <i class="fa fa-lightbulb-o text-primary text-xl mt-1 mr-3"></i>
        <div>
          <h4 class="font-semibold text-primary mb-1">Practice Tips</h4>
          <p class="text-sm text-neutral-500 dark:text-neutral-300">
            Your progress is automatically saved. Hide sentences with the eye button to test your memory, 
            then use the input field to practice writing them. Listen to check your pronunciation!
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-white dark:bg-neutral-600 py-6 mt-auto">
    <div class="container mx-auto px-4 text-center text-neutral-400 dark:text-neutral-500 text-sm">
      <p>LineSpeak - Improve your English speaking skills effectively</p>
    </div>
  </footer>

  <script>
    // DOM 元素
    const textInput = document.getElementById('text-input');
    const processBtn = document.getElementById('process-btn');
    const resultsSection = document.getElementById('results-section');
    const sentencesContainer = document.getElementById('sentences-container');
    const themeToggle = document.getElementById('theme-toggle');
    const playAllBtn = document.getElementById('play-all-btn');
    const playUnmasteredBtn = document.getElementById('play-unmastered-btn');
    const stopAllBtn = document.getElementById('stop-all-btn');
    const playProgress = document.getElementById('play-progress');
    const masteryPercentage = document.getElementById('mastery-percentage');
    
    // 存储键名
    const STORAGE_KEYS = {
      TEXT_CONTENT: 'linespeak_text_content',
      MASTERED_SENTENCES: 'linespeak_mastered_sentences',
      HIDDEN_SENTENCES: 'linespeak_hidden_sentences',
      MASKED_INPUTS: 'linespeak_masked_inputs',
      DARK_MODE: 'darkMode'
    };
    
    // 播放状态变量
    let isPlayingAll = false;
    let isPlayingUnmastered = false;
    let currentSentenceIndex = 0;
    let sentencesList = [];
    let masteredSentences = []; // 存储已掌握的句子索引
    let hiddenSentences = [];   // 存储隐藏状态的句子索引
    
    // 初始化 - 从本地存储加载数据
    function initialize() {
      // 加载深色模式设置
      const darkMode = localStorage.getItem(STORAGE_KEYS.DARK_MODE);
      if (darkMode === 'true' || 
          (!darkMode && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
      
      // 加载保存的文本内容
      const savedText = localStorage.getItem(STORAGE_KEYS.TEXT_CONTENT);
      if (savedText) {
        textInput.value = savedText;
      } else {
        // 使用默认示例文本
        textInput.value = exampleText;
      }
      
      // 处理文本（如果有内容）
      if (textInput.value.trim()) {
        processText(false); // false 表示不滚动到结果区域
      }
    }
    
    // 深色模式切换
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem(STORAGE_KEYS.DARK_MODE, document.documentElement.classList.contains('dark'));
    });
    
    // 处理文本并按行断句
    processBtn.addEventListener('click', () => {
      processText(true);
    });
    
    // 按Enter+Shift提交
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.shiftKey) {
        e.preventDefault();
        processText(true);
      }
    });
    
    // 文本输入变化时保存到本地存储
    textInput.addEventListener('input', debounce(() => {
      localStorage.setItem(STORAGE_KEYS.TEXT_CONTENT, textInput.value);
    }, 500));
    
    // 播放全部按钮事件
    playAllBtn.addEventListener('click', () => {
      startPlayback(true);
    });
    
    // 播放未掌握按钮事件
    playUnmasteredBtn.addEventListener('click', () => {
      startPlayback(false);
    });
    
    // 停止播放按钮事件
    stopAllBtn.addEventListener('click', stopPlayback);
    
    // 开始播放（全部或仅未掌握）
    function startPlayback(includeMastered) {
      if (sentencesList.length === 0) return;
      
      // 重置状态
      stopPlayback();
      isPlayingAll = includeMastered;
      isPlayingUnmastered = !includeMastered;
      currentSentenceIndex = 0;
      
      // 更新UI
      playAllBtn.classList.add('hidden');
      playUnmasteredBtn.classList.add('hidden');
      stopAllBtn.classList.remove('hidden');
      
      // 开始播放第一个句子
      playNextSentence();
    }
    
    // 处理文本函数 - 按行分割
    function processText(scrollToResults = true) {
      const text = textInput.value.trim();
      if (!text) return;
      
      // 保存文本内容到本地存储
      localStorage.setItem(STORAGE_KEYS.TEXT_CONTENT, text);
      
      // 按行分割文本，过滤空行
      sentencesList = text.split('\n').filter(line => line.trim() !== '');
      
      // 从本地存储加载已掌握的句子状态
      const savedMastered = localStorage.getItem(STORAGE_KEYS.MASTERED_SENTENCES);
      if (savedMastered) {
        const parsedMastered = JSON.parse(savedMastered);
        // 确保数组长度与句子数量一致
        masteredSentences = Array(sentencesList.length).fill(false);
        parsedMastered.forEach((isMastered, index) => {
          if (index < masteredSentences.length) {
            masteredSentences[index] = isMastered;
          }
        });
      } else {
        // 重置已掌握状态
        masteredSentences = new Array(sentencesList.length).fill(false);
      }
      
      // 从本地存储加载隐藏状态
      const savedHidden = localStorage.getItem(STORAGE_KEYS.HIDDEN_SENTENCES);
      if (savedHidden) {
        const parsedHidden = JSON.parse(savedHidden);
        hiddenSentences = Array(sentencesList.length).fill(true); // 默认隐藏所有句子
        parsedHidden.forEach((isHidden, index) => {
          if (index < hiddenSentences.length) {
            hiddenSentences[index] = isHidden;
          }
        });
      } else {
        // 默认隐藏所有句子
        hiddenSentences = new Array(sentencesList.length).fill(true);
      }
      
      // 清空并显示结果区域
      sentencesContainer.innerHTML = '';
      resultsSection.classList.remove('hidden');
      
      // 重置播放进度
      updateProgress(0);
      
      // 更新掌握度显示
      updateMasteryPercentage();
      
      // 平滑滚动到结果区域（如果需要）
      if (scrollToResults) {
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      // 为每个句子创建元素
      sentencesList.forEach((sentence, index) => {
        const trimmedSentence = sentence.trim();
        if (trimmedSentence) {
          const sentenceElement = createSentenceElement(trimmedSentence, index);
          sentencesContainer.appendChild(sentenceElement);
          // 元素已添加到DOM后再更新可见性
          updateSentenceVisibility(index);
        }
      });
      
      // 加载保存的默写内容
      loadMaskedInputs();
    }
    
    // 创建句子元素
    function createSentenceElement(sentence, index) {
      // 创建主容器
      const container = document.createElement('div');
      container.className = 'p-3 rounded-lg sentence-hover';
      container.dataset.index = index;
      container.id = `sentence-container-${index}`;
      
      // 如果是已掌握的句子，添加相应样式
      if (masteredSentences[index]) {
        container.classList.add('sentence-mastered');
      }
      
      // 创建句子行
      const sentenceRow = document.createElement('div');
      sentenceRow.className = 'flex items-start mb-3'; // 使用items-start确保内容能换行显示
      
      // 序号徽章
      const numberBadge = document.createElement('div');
      numberBadge.className = 'number-badge mt-0.5'; // 微调垂直位置
      numberBadge.textContent = index + 1;
      
      // 播放按钮
      const playBtn = document.createElement('button');
      playBtn.className = 'mr-3 text-primary hover:text-primary/80 transition-colors p-2 rounded-full hover:bg-primary/10 focus:outline-none focus:ring-2 focus:ring-primary/30 flex items-center justify-center flex-shrink-0 mt-0.5'; // 微调垂直位置
      playBtn.innerHTML = '<i class="fa fa-play"></i>';
      playBtn.dataset.index = index;
      playBtn.title = 'Play this sentence';
      
      // 句子文本容器
      const textContainer = document.createElement('div');
      textContainer.className = 'flex-1';
      
      // 句子文本
      const textSpan = document.createElement('span');
      textSpan.className = 'leading-relaxed';
      textSpan.textContent = sentence;
      textSpan.id = `sentence-text-${index}`;
      
      // 隐藏状态下显示星号掩码 - 改进版本
      const maskedSpan = document.createElement('span');
      maskedSpan.className = 'leading-relaxed masked-text hidden';
      maskedSpan.id = `sentence-masked-${index}`;
      
      // 生成与原句结构相似的掩膜（保留换行和空格结构）
      maskedSpan.textContent = createMaskedText(sentence);
      
      textContainer.appendChild(textSpan);
      textContainer.appendChild(maskedSpan);
      
      // 控制按钮容器
      const controlsContainer = document.createElement('div');
      controlsContainer.className = 'flex items-center space-x-1 ml-2';
      
      // 眼睛按钮（显示/隐藏）
      const eyeBtn = document.createElement('button');
      eyeBtn.className = `transition-colors p-2 rounded-full hover:bg-neutral-200 dark:hover:bg-neutral-500 focus:outline-none focus:ring-2 focus:ring-neutral-300 dark:focus:ring-neutral-400 flex items-center justify-center flex-shrink-0`;
      eyeBtn.innerHTML = hiddenSentences[index] ? '<i class="fa fa-eye-slash text-neutral-500"></i>' : '<i class="fa fa-eye text-neutral-500"></i>';
      eyeBtn.dataset.index = index;
      eyeBtn.title = hiddenSentences[index] ? 'Show sentence' : 'Hide sentence';
      
      // 掌握按钮
      const masterBtn = document.createElement('button');
      masterBtn.className = `transition-colors p-2 rounded-full hover:bg-success/10 focus:outline-none focus:ring-2 focus:ring-success/30 flex items-center justify-center flex-shrink-0 ${masteredSentences[index] ? 'text-success' : 'text-neutral-400 hover:text-success'}`;
      masterBtn.innerHTML = '<i class="fa fa-check"></i>';
      masterBtn.dataset.index = index;
      masterBtn.title = masteredSentences[index] ? 'Unmark as mastered' : 'Mark as mastered';
      
      controlsContainer.appendChild(eyeBtn);
      controlsContainer.appendChild(masterBtn);
      
      // 组装句子行
      sentenceRow.appendChild(numberBadge);
      sentenceRow.appendChild(playBtn);
      sentenceRow.appendChild(textContainer);
      sentenceRow.appendChild(controlsContainer);
      
      // 默写输入框
      const inputContainer = document.createElement('div');
      inputContainer.className = 'mt-2 ml-14'; // 缩进与句子对齐
      
      const input = document.createElement('input');
      input.type = 'text';
      input.id = `sentence-input-${index}`;
      input.className = 'w-full p-2 border border-neutral-200 dark:border-neutral-500 rounded-lg bg-neutral-50 dark:bg-neutral-700 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all text-sm';
      input.placeholder = 'Type the sentence here to practice...';
      
      // 验证按钮
      const checkBtn = document.createElement('button');
      checkBtn.className = 'mt-1 bg-primary/10 hover:bg-primary/20 text-primary px-3 py-1 rounded text-sm transition-colors';
      checkBtn.innerHTML = '<i class="fa fa-check-circle mr-1"></i> Check';
      checkBtn.dataset.index = index;
      
      // 验证结果
      const resultMsg = document.createElement('div');
      resultMsg.id = `sentence-result-${index}`;
      resultMsg.className = 'mt-1 text-sm hidden';
      
      inputContainer.appendChild(input);
      inputContainer.appendChild(checkBtn);
      inputContainer.appendChild(resultMsg);
      
      // 组装容器
      container.appendChild(sentenceRow);
      container.appendChild(inputContainer);
      
      // 播放按钮点击事件
      playBtn.addEventListener('click', (e) => {
        const idx = parseInt(e.currentTarget.dataset.index);
        stopPlayback(); // 停止连播
        speakSentence(sentencesList[idx], container, playBtn, idx, false);
      });
      
      // 点击句子文本也可以播放
      textSpan.addEventListener('click', () => {
        stopPlayback(); // 停止连播
        speakSentence(sentence, container, playBtn, index, false);
      });
      
      maskedSpan.addEventListener('click', () => {
        stopPlayback(); // 停止连播
        speakSentence(sentence, container, playBtn, index, false);
      });
      
      // 掌握按钮点击事件
      masterBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(e.currentTarget.dataset.index);
        toggleMasteredStatus(idx, container, masterBtn);
      });
      
      // 眼睛按钮点击事件（显示/隐藏句子）
      eyeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(e.currentTarget.dataset.index);
        toggleSentenceVisibility(idx, eyeBtn);
      });
      
      // 验证按钮点击事件
      checkBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(e.currentTarget.dataset.index);
        checkInput(idx, input, resultMsg);
      });
      
      // 输入框回车事件
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const idx = parseInt(input.dataset.index);
          checkInput(idx, input, resultMsg);
        }
      });
      
      // 保存输入框数据
      input.addEventListener('input', debounce(() => {
        saveMaskedInput(index, input.value);
      }, 300));
      
      // 关联索引
      input.dataset.index = index;
      
      return container;
    }
    
    // 创建与原句结构相似的掩膜文本（保留换行和空格）
    function createMaskedText(original) {
      // 将每个字符替换为*，但保留原有的换行和空格结构
      return original.split('').map(char => {
        // 保留换行符和空格，其他字符替换为*
        if (char === '\n' || char === ' ') return char;
        return '*';
      }).join('');
    }
    
    // 切换句子显示/隐藏状态
    function toggleSentenceVisibility(index, button) {
      // 切换状态
      hiddenSentences[index] = !hiddenSentences[index];
      
      // 保存到本地存储
      localStorage.setItem(STORAGE_KEYS.HIDDEN_SENTENCES, JSON.stringify(hiddenSentences));
      
      // 更新UI
      updateSentenceVisibility(index);
      
      // 更新按钮
      if (hiddenSentences[index]) {
        button.innerHTML = '<i class="fa fa-eye-slash text-neutral-500"></i>';
        button.title = 'Show sentence';
      } else {
        button.innerHTML = '<i class="fa fa-eye text-neutral-500"></i>';
        button.title = 'Hide sentence';
      }
    }
    
    // 更新句子可见性
    function updateSentenceVisibility(index) {
      // 获取元素并添加存在性检查
      const textSpan = document.getElementById(`sentence-text-${index}`);
      const maskedSpan = document.getElementById(`sentence-masked-${index}`);
      
      // 确保元素存在再进行操作
      if (!textSpan || !maskedSpan) {
        console.warn(`Sentence elements for index ${index} not found`);
        return;
      }
      
      if (hiddenSentences[index]) {
        textSpan.classList.add('hidden');
        maskedSpan.classList.remove('hidden');
      } else {
        textSpan.classList.remove('hidden');
        maskedSpan.classList.add('hidden');
      }
    }
    
    // 检查默写输入
    function checkInput(index, input, resultMsg) {
      const userInput = input.value.trim();
      const originalSentence = sentencesList[index].trim();
      
      // 忽略大小写和标点符号的简单比较
      const normalize = (str) => str.toLowerCase().replace(/[^\w\s]/gi, '');
      
      if (normalize(userInput) === normalize(originalSentence)) {
        // 正确
        resultMsg.textContent = 'Perfect! That\'s correct.';
        resultMsg.className = 'mt-1 text-sm text-success';
        input.classList.remove('border-danger', 'border-neutral-200', 'dark:border-neutral-500');
        input.classList.add('border-success');
      } else {
        // 错误
        resultMsg.textContent = `Not quite right. Correct: "${originalSentence}"`;
        resultMsg.className = 'mt-1 text-sm text-danger';
        input.classList.remove('border-success', 'border-neutral-200', 'dark:border-neutral-500');
        input.classList.add('border-danger');
      }
    }
    
    // 保存默写输入内容
    function saveMaskedInput(index, value) {
      let inputs = JSON.parse(localStorage.getItem(STORAGE_KEYS.MASKED_INPUTS) || '{}');
      inputs[index] = value;
      localStorage.setItem(STORAGE_KEYS.MASKED_INPUTS, JSON.stringify(inputs));
    }
    
    // 加载保存的默写内容
    function loadMaskedInputs() {
      const inputs = JSON.parse(localStorage.getItem(STORAGE_KEYS.MASKED_INPUTS) || '{}');
      for (const [index, value] of Object.entries(inputs)) {
        const inputElement = document.getElementById(`sentence-input-${index}`);
        if (inputElement) {
          inputElement.value = value;
        }
      }
    }
    
    // 切换掌握状态
    function toggleMasteredStatus(index, sentenceElement, button) {
      // 切换状态
      masteredSentences[index] = !masteredSentences[index];
      
      // 保存到本地存储
      localStorage.setItem(STORAGE_KEYS.MASTERED_SENTENCES, JSON.stringify(masteredSentences));
      
      // 更新UI
      if (masteredSentences[index]) {
        sentenceElement.classList.add('sentence-mastered');
        button.classList.remove('text-neutral-400');
        button.classList.add('text-success');
        button.title = 'Unmark as mastered';
      } else {
        sentenceElement.classList.remove('sentence-mastered');
        button.classList.remove('text-success');
        button.classList.add('text-neutral-400', 'hover:text-success');
        button.title = 'Mark as mastered';
      }
      
      // 更新掌握度百分比
      updateMasteryPercentage();
    }
    
    // 更新掌握度百分比
    function updateMasteryPercentage() {
      if (sentencesList.length === 0) {
        masteryPercentage.classList.add('hidden');
        return;
      }
      
      const masteredCount = masteredSentences.filter(status => status).length;
      const percentage = Math.round((masteredCount / sentencesList.length) * 100);
      
      masteryPercentage.textContent = `${percentage}% Mastered`;
      masteryPercentage.classList.remove('hidden');
      
      // 根据掌握程度改变徽章颜色
      if (percentage === 100) {
        masteryPercentage.classList.remove('bg-primary/10', 'text-primary', 'dark:bg-primary/20');
        masteryPercentage.classList.add('bg-success/10', 'text-success', 'dark:bg-success/20');
      } else {
        masteryPercentage.classList.remove('bg-success/10', 'text-success', 'dark:bg-success/20');
        masteryPercentage.classList.add('bg-primary/10', 'text-primary', 'dark:bg-primary/20');
      }
    }
    
    // 播放下一个句子
    function playNextSentence() {
      if ((!isPlayingAll && !isPlayingUnmastered) || currentSentenceIndex >= sentencesList.length) {
        // 播放结束
        finishPlayback();
        return;
      }
      
      // 如果是播放未掌握模式，找到下一个未掌握的句子
      if (isPlayingUnmastered) {
        let found = false;
        while (currentSentenceIndex < sentencesList.length) {
          if (!masteredSentences[currentSentenceIndex]) {
            found = true;
            break;
          }
          currentSentenceIndex++;
        }
        
        if (!found) {
          // 没有未掌握的句子了
          finishPlayback();
          return;
        }
      }
      
      // 获取当前句子元素
      const sentence = sentencesList[currentSentenceIndex];
      const sentenceElement = document.getElementById(`sentence-container-${currentSentenceIndex}`);
      if (!sentenceElement) {
        finishPlayback();
        return;
      }
      
      const playBtn = sentenceElement.querySelector('button:first-of-type');
      if (!playBtn) {
        currentSentenceIndex++;
        setTimeout(playNextSentence, 100);
        return;
      }
      
      // 播放当前句子
      speakSentence(sentence, sentenceElement, playBtn, currentSentenceIndex, true);
      
      // 更新进度
      const totalToPlay = isPlayingUnmastered 
        ? sentencesList.filter((_, i) => !masteredSentences[i]).length
        : sentencesList.length;
      
      const completed = isPlayingUnmastered
        ? sentencesList.filter((_, i) => i < currentSentenceIndex && !masteredSentences[i]).length + 1
        : currentSentenceIndex + 1;
      
      const progress = totalToPlay > 0 ? (completed / totalToPlay) * 100 : 0;
      updateProgress(progress);
      
      // 滚动到当前句子
      sentenceElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // 结束播放
    function finishPlayback() {
      isPlayingAll = false;
      isPlayingUnmastered = false;
      
      // 重置所有句子和按钮状态
      resetAllSentenceStates();
      
      // 更新UI
      playAllBtn.classList.remove('hidden');
      playUnmasteredBtn.classList.remove('hidden');
      stopAllBtn.classList.add('hidden');
      
      // 重置进度
      updateProgress(0);
    }
    
    // 停止播放
    function stopPlayback() {
      if (!isPlayingAll && !isPlayingUnmastered) return;
      
      // 停止语音播放
      window.speechSynthesis.cancel();
      
      finishPlayback();
    }
    
    // 更新进度条
    function updateProgress(percent) {
      playProgress.style.width = `${percent}%`;
    }
    
    // 重置所有句子状态
    function resetAllSentenceStates() {
      // 遍历所有句子容器，添加存在性检查
      document.querySelectorAll('[id^="sentence-container-"]').forEach(el => {
        if (el) { // 确保元素存在
          // 保留已掌握状态，但移除活跃状态
          if (!el.classList.contains('sentence-mastered')) {
            el.classList.remove('sentence-active');
          }
        }
      });
      
      // 遍历所有播放按钮，添加存在性检查
      document.querySelectorAll('[id^="sentence-container-"] button:first-of-type').forEach(btn => {
        if (btn) { // 确保按钮存在
          btn.innerHTML = '<i class="fa fa-play"></i>';
          btn.classList.remove('text-secondary');
          btn.classList.add('text-primary');
        }
      });
    }
    
    // 语音播放函数
    function speakSentence(text, sentenceElement, button, index, isPartOfSequence) {
      // 检查元素是否存在
      if (!sentenceElement || !button) return;
      
      // 停止任何正在播放的语音
      window.speechSynthesis.cancel();
      
      // 重置所有句子和按钮状态
      resetAllSentenceStates();
      
      // 设置当前句子和按钮状态
      if (!sentenceElement.classList.contains('sentence-mastered')) {
        sentenceElement.classList.add('sentence-active');
      }
      button.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
      button.classList.remove('text-primary');
      button.classList.add('text-secondary');
      
      // 创建语音实例
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.9; // 稍慢一点便于学习
      utterance.pitch = 1;
      utterance.volume = 1;
      
      // 播放结束时的处理
      utterance.onend = () => {
        // 检查元素是否仍然存在
        if (!sentenceElement || !button) return;
        
        // 如果是连播模式，继续下一个句子
        if (isPartOfSequence && (isPlayingAll || isPlayingUnmastered) && index === currentSentenceIndex) {
          currentSentenceIndex++;
          // 短暂延迟后播放下一句
          setTimeout(playNextSentence, 500);
        } else {
          // 重置当前句子状态
          sentenceElement.classList.remove('sentence-active');
          button.innerHTML = '<i class="fa fa-play"></i>';
          button.classList.remove('text-secondary');
          button.classList.add('text-primary');
        }
      };
      
      // 播放错误处理
      utterance.onerror = (event) => {
        console.error('Speech error:', event.error);
        
        // 检查元素是否仍然存在
        if (!sentenceElement || !button) return;
        
        button.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
        button.classList.remove('text-secondary');
        button.classList.add('text-red-500');
        
        // 如果是连播模式，继续下一个句子
        if (isPartOfSequence && (isPlayingAll || isPlayingUnmastered)) {
          currentSentenceIndex++;
          setTimeout(playNextSentence, 1000);
        } else {
          // 3秒后恢复按钮状态
          setTimeout(() => {
            // 再次检查元素是否存在
            if (sentenceElement && button) {
              sentenceElement.classList.remove('sentence-active');
              button.innerHTML = '<i class="fa fa-play"></i>';
              button.classList.remove('text-red-500');
              button.classList.add('text-primary');
            }
          }, 3000);
        }
      };
      
      // 播放语音
      window.speechSynthesis.speak(utterance);
    }
    
    // 防抖函数 - 避免频繁保存
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // 示例文本
    const exampleText = `Good morning/afternoon.
Thanks for having me today.
I’m Qin Kai Wen, and I’m applying for the Web Front-End Development job.
First, I have a bachelor’s degree in Geographic Information Systems from Beijing Forestry University.
I studied there from 2010 to 2014.
Since graduating, I’ve worked in front-end development for over 8 years.
And 5 of those years were on financial projects.
My last job was at Shenzhen Farben Information Technology (Guangzhou Branch) from September 2020 to January 2023.
There, I was a Web Front-End Engineer.
My main work was on two HSBC projects: the Wealth Dashboard and Wealth Product Catalog.
Let me tell you a bit about that.
First, I built the front end with React.
I also worked with the back-end team—they used Spring Boot—to make sure data moved smoothly between front and back.
Second, I set up automated tests.
I used Jest for unit tests, and even made coverage reports for them.
I used Testcafe for E2E tests too.
Then I got all these tests running on Jenkins.
This made regression testing faster, and the system more reliable and easier to maintain.
Third, I helped with small back-end tasks.
For example, I developed simple APIs, maintained them, and wrote unit tests for back-end code with Karate/JUnit.
Before Faben, I worked at Pactera Jinxin and South Digital.
Those jobs let me get really good at Vue, Angular, and TypeScript.
I also worked on projects like GF Securities’ customer relationship systems and GIS-based tax analysis tools back then.
Overall, I’m skilled in HTML, JS, CSS, React, Vue, Angular, TypeScript, and webpack.
I’m good at writing code that’s easy to reuse and maintain—this is done using Flux architecture.
I also know how to meet the strict standards of the financial industry.
I’m excited to bring these skills to your team.
Thanks!`;
    
    // 页面加载时初始化
    window.addEventListener('load', initialize);
  </script>
</body>
</html>
